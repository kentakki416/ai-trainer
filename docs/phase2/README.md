# Phase 2: 機能拡張 - 詳細設計書

## 概要

Phase 2では、Phase 1で実装したMVPにユーザー体験を向上させる追加機能を実装する。

**開発期間**: 4週間

**目標**: リマインダー機能、実績システム、詳細な統計機能を追加し、ユーザーのモチベーション維持とエンゲージメント向上を図る。

---

## 機能要件

### 1. リマインダー機能

#### 1.1 プッシュ通知

**対応プラットフォーム**:
- Webブラウザ通知（Push API）
- メール通知（バックアップ）

**通知タイミング**:
1. **毎日の決まった時間**:
   - ユーザーが設定した時刻に通知（デフォルト: 20:00）
   - 「今日の進捗を記録しよう！」

2. **入力を3日間忘れた場合**:
   - 特別リマインダー
   - 「トレちゃんが待っているよ！」

3. **中間ゴール達成予定日の1週間前**:
   - 進捗確認リマインダー
   - 「あと1週間で中間ゴール達成だよ！」

**通知内容**:
- タイトル
- メッセージ本文
- キャラクターからのメッセージ
- アクションボタン（「記録する」など）

**実装**:
- Web Push API
- サービスワーカー（Service Worker）
- バックエンドのスケジューラー（node-cron）

#### 1.2 通知設定

**設定項目**:
- 通知ON/OFF
- 通知時刻の設定（時/分）
- 通知タイプの選択:
  - 毎日のリマインダー
  - 長期未入力アラート
  - 中間ゴール期限アラート

---

### 2. 実績（Achievements）システム

#### 2.1 実績の種類

**学習継続系**:
- 🔥 「3日連続入力」
- 🔥 「7日連続入力」
- 🔥 「30日連続入力」
- 🔥 「100日連続入力」

**累計学習時間系**:
- ⏱️ 「累計10時間学習」
- ⏱️ 「累計50時間学習」
- ⏱️ 「累計100時間学習」
- ⏱️ 「累計500時間学習」

**目標達成系**:
- 🎯 「初めての中間ゴール達成」
- 🎯 「中間ゴール3つ達成」
- 🎯 「中間ゴール5つ達成」
- 🏆 「メインゴール達成」

**特別実績**:
- 🌟 「深夜学習者（23時以降の記録10回）」
- 🌟 「早起き学習者（6時前の記録10回）」
- 🌟 「週末戦士（土日の記録10回）」

#### 2.2 バッジシステム

**バッジの表示**:
- プロフィール画面にバッジ一覧
- 未達成のバッジはグレーアウト表示
- 達成済みのバッジはカラー表示

**バッジ達成時の演出**:
- バッジ獲得アニメーション
- お祝いメッセージ
- SNSシェア機能（オプション）

#### 2.3 実装

**データベース**:
- `achievements` テーブル: 実績マスターデータ
- `user_achievements` テーブル: ユーザーの実績達成状況

**チェックロジック**:
- 進捗入力時にバックグラウンドで実績チェック
- 達成条件を満たした場合、`user_achievements` に記録
- フロントエンドにバッジ獲得を通知

---

### 3. 詳細な統計・分析機能

#### 3.1 進捗グラフ（Phase 1から移行）

**グラフの種類**:
- **累積学習時間の折れ線グラフ**: 日次・週次・月次の切り替え可能
- **中間ゴールまでの進捗バー**: 各中間ゴールの達成度を視覚化
- **メインゴールまでの進捗バー**: 全体の進捗状況を一目で確認
- **日次学習時間の折れ線グラフ**: 直近30日間の学習時間推移
- **週次学習時間の棒グラフ**: 直近12週間の学習時間
- **月次学習時間の棒グラフ**: 直近12ヶ月の学習時間
- **時間帯別学習分布（ヒートマップ）**: どの時間帯に学習しているかを可視化

**実装**:
- ライブラリ: Chart.js または Recharts
- アニメーション付きで数値が変化
- レスポンシブ対応（モバイルでも見やすい）
- インタラクティブ（ホバーで詳細表示）

#### 3.2 統計ダッシュボード

**表示内容**:

##### 学習時間統計
- 今週の総学習時間
- 今月の総学習時間
- 累計学習時間
- 日平均学習時間
- 最長連続学習日数

##### 目標達成状況
- メインゴールまでの進捗率
- 次の中間ゴールまでの進捗率
- 達成した中間ゴール数
- 残りの必要学習時間

#### 3.3 AI による進捗分析（プレミアム機能）

**無料版**:
- 基本的な統計情報のみ

**プレミアム版**:
- **週次または月次**でAIが進捗を分析
- 進捗が遅れている場合、中間ゴールの再提案
- 進捗が早い場合、より高い中間ゴールを提案
- 学習効率の分析とアドバイス
- ユーザーは提案を受け入れるか、無視するか選択可能

**分析レポート内容**:
- 進捗状況の評価
- 改善提案
- 学習ペースの分析
- 目標達成可能性の予測

---

### 4. UI/UX改善

#### 4.1 アニメーション強化

**追加アニメーション**:
- ページ遷移アニメーション（フェード、スライド）
- カード展開アニメーション
- 数値カウントアップアニメーション
- ローディングスケルトン
- マイクロインタラクション（ボタンホバー、クリックなど）

**パフォーマンス最適化**:
- GPU アクセラレーション
- 60fps 維持
- アニメーション遅延の最小化

#### 4.2 レスポンシブデザイン改善

**モバイル最適化**:
- タッチジェスチャー対応
- スワイプ操作（カレンダー、中間ゴールなど）
- ボトムシート UI
- ハンバーガーメニュー

**タブレット対応**:
- 2カラムレイアウト
- サイドバーメニュー
- より大きなカード表示

#### 4.3 アクセシビリティ改善

**対応項目**:
- キーボードナビゲーション
- スクリーンリーダー対応
- コントラスト比の確保（WCAG 2.1 AA準拠）
- フォーカス表示の明確化
- alt属性の設定

---

### 5. パフォーマンス最適化

#### 5.1 フロントエンド最適化

**実装内容**:
- コード分割（Dynamic Import）
- 画像の最適化（Next.js Image）
- バンドルサイズの削減
- キャッシング戦略（SWR / React Query）
- Service Worker によるオフライン対応

**目標**:
- Lighthouse スコア 90点以上
- First Contentful Paint (FCP): 1.5秒以内
- Largest Contentful Paint (LCP): 2.5秒以内
- Cumulative Layout Shift (CLS): 0.1以下

#### 5.2 バックエンド最適化

**実装内容**:
- データベースクエリの最適化
- N+1問題の解決
- レスポンスキャッシング（Redis導入検討）
- API レート制限の改善
- ログの最適化

**目標**:
- API レスポンスタイム: 200ms以内
- データベースクエリタイム: 50ms以内

---

## 非機能要件

### 1. パフォーマンス
- ページ読み込み時間: 2秒以内（Phase 1より1秒改善）
- アニメーション: 60fps 維持
- API レスポンス: 200ms以内

### 2. 可用性
- 稼働率: 99%以上を目指す
- エラーハンドリングの強化
- リトライ機構の実装

### 3. スケーラビリティ
- 1,000〜5,000人のユーザーに対応
- データベース接続プールの最適化
- API レート制限の実装

---

## データベース設計

**新規テーブル**:

### achievements
実績マスターデータ

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | UUID | 主キー |
| name | VARCHAR | 実績名 |
| description | TEXT | 実績の説明 |
| category | VARCHAR | カテゴリ（継続、累計など） |
| condition | JSONB | 達成条件 |
| icon | VARCHAR | アイコン |
| created_at | TIMESTAMP | 作成日時 |

### user_achievements
ユーザーの実績達成状況

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | UUID | 主キー |
| user_id | UUID | ユーザーID |
| achievement_id | UUID | 実績ID |
| achieved_at | TIMESTAMP | 達成日時 |
| created_at | TIMESTAMP | 作成日時 |

### notification_settings
通知設定

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | UUID | 主キー |
| user_id | UUID | ユーザーID |
| daily_reminder_enabled | BOOLEAN | 毎日のリマインダー |
| reminder_time | TIME | リマインダー時刻 |
| long_absence_alert | BOOLEAN | 長期未入力アラート |
| milestone_deadline_alert | BOOLEAN | 中間ゴール期限アラート |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

---

## API設計

**新規エンドポイント**:

### 通知
- `GET /api/notifications/settings`: 通知設定取得
- `PATCH /api/notifications/settings`: 通知設定更新
- `POST /api/notifications/subscribe`: プッシュ通知登録

### 実績
- `GET /api/achievements`: 実績一覧取得
- `GET /api/achievements/user`: ユーザーの達成済み実績取得

### 統計
- `GET /api/stats/summary`: 統計サマリー取得
- `GET /api/stats/daily`: 日次統計取得
- `GET /api/stats/weekly`: 週次統計取得
- `GET /api/stats/monthly`: 月次統計取得

---

## 開発スケジュール

### Week 9-10: リマインダー・実績システム
- プッシュ通知機能の実装
- サービスワーカーの実装
- 通知設定画面の実装
- 実績システムの実装
- バッジ表示の実装
- 実績チェックロジックの実装

### Week 11: UI/UX改善
- アニメーション強化
- レスポンシブデザイン改善
- アクセシビリティ対応
- ダークモード実装（オプション）

### Week 12: パフォーマンス最適化
- フロントエンド最適化
- バックエンド最適化
- データベースクエリ最適化
- パフォーマンステスト
- 負荷テスト

---

## テスト戦略

### 単体テスト
- 新規機能のカバレッジ: 80%以上
- 実績チェックロジックのテスト
- 通知送信ロジックのテスト

### 統合テスト
- プッシュ通知のE2Eテスト
- 実績システムの統合テスト
- 統計APIの統合テスト

### パフォーマンステスト
- Lighthouse スコア 90点以上
- API レスポンスタイムの測定
- データベースクエリパフォーマンスの測定

---

## 制約事項

1. **プッシュ通知**: ブラウザの通知許可が必要
2. **オフライン対応**: 限定的（閲覧のみ、編集不可）
3. **AI分析（プレミアム機能）**: 無料版では利用不可

---

## Phase 3 への移行準備

Phase 2完了後、以下の準備を行う:

1. **ベータテスト環境の構築**
2. **ベータテスター募集**
3. **フィードバック収集の仕組み構築**
4. **ドキュメント整備**
5. **マーケティング準備**

---

## 承認

| 役割 | 氏名 | 承認日 |
|------|------|--------|
| プロダクトオーナー | - | - |
| 開発リード | - | - |

---

**作成日**: 2025-12-01
**最終更新日**: 2025-12-01
**バージョン**: 1.0
